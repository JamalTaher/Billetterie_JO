{% extends 'admin/index.html.twig' %}

{% block title %}Créer un nouvel événement{% endblock %}

{% block body_content %}
    <h1>Créer un nouvel événement</h1>

    {{ form_start(form) }}
        {{ form_row(form.nom) }}
        {{ form_row(form.categorie) }}
       
        {{ form_row(form.dateHeure) }}
        {{ form_row(form.lieu) }}
        {{ form_row(form.description) }}

        <h2>Prix et Offres</h2>
        
        <ul class="prix-offres"
            data-prototype="{{ form_widget(form.prixOffreEvenements.vars.prototype)|e('html_attr') }}"
            data-index="{{ form.prixOffreEvenements|length > 0 ? form.prixOffreEvenements|last.vars.name + 1 : 0 }}">
            {% for prixOffreEvenement in form.prixOffreEvenements %}
                <li>
                    {{ form_row(prixOffreEvenement.offre) }}
                    {{ form_row(prixOffreEvenement.prix) }}
                    <button type="button" class="btn btn-danger btn-sm remove-collection-widget">Supprimer</button>
                </li>
            {% endfor %}
        </ul>
        <button type="button" class="btn btn-primary add-collection-widget" data-list-selector=".prix-offres">Ajouter un Prix/Offre</button>

        <button type="submit" class="btn btn-success mt-3">Créer l'événement</button>
    {{ form_end(form) }}

    <a href="{{ path('admin_evenements_list') }}" class="btn btn-secondary mt-3">Retour à la liste des événements</a>

    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addTagFormDeleteLink = (item) => {
                const removeFormButton = item.querySelector('.remove-collection-widget');
                if (removeFormButton) {
                    removeFormButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        item.remove(); // Supprime l'élément (li) parent
                    });
                }
            };

            const addFormToCollection = (e) => {
                const collectionHolder = document.querySelector(e.currentTarget.dataset.listSelector);
                const item = document.createElement('li'); // Crée un nouvel élément li pour chaque offre

                item.innerHTML = collectionHolder.dataset.prototype.replace(
                    /__name__/g,
                    collectionHolder.dataset.index
                );

                collectionHolder.appendChild(item);
                collectionHolder.dataset.index = parseInt(collectionHolder.dataset.index) + 1;

                addTagFormDeleteLink(item); // Ajoute le bouton de suppression au nouvel élément

               
                const offreSelect = item.querySelector('select[id$="_offre"]');
                const prixInput = item.querySelector('input[id$="_prix"]');

                if (offreSelect && prixInput) {
                    
                    const updatePrix = () => {
                        const selectedOption = offreSelect.options[offreSelect.selectedIndex];
                        const prixStandard = selectedOption ? selectedOption.dataset.prixStandard : '';
                        
                       
                        if (prixInput.value === '') {
                             prixInput.value = prixStandard;
                        }
                    };

                   
                    offreSelect.addEventListener('change', updatePrix);

                    
                    updatePrix();
                }
            };

            document
                .querySelectorAll('.add-collection-widget')
                .forEach(btn => btn.addEventListener("click", addFormToCollection));

            document
                .querySelectorAll('ul.prix-offres > li')
                .forEach(addTagFormDeleteLink);

        
            document.querySelectorAll('ul.prix-offres > li').forEach(item => {
                const offreSelect = item.querySelector('select[id$="_offre"]');
                const prixInput = item.querySelector('input[id$="_prix"]');

                if (offreSelect && prixInput) {
                    const updatePrixInitial = () => {
                        const selectedOption = offreSelect.options[offreSelect.selectedIndex];
                        const prixStandard = selectedOption ? selectedOption.dataset.prixStandard : '';
                        
                      
                        if (prixInput.value === '' || (prixInput.value == prixStandard && prixStandard !== '')) { // Comparaison lâche pour les nombres
                             prixInput.value = prixStandard;
                        }
                    };
                    offreSelect.addEventListener('change', updatePrixInitial);
                    updatePrixInitial(); // Appeler une fois au chargement
                }
            });
        });
    </script>
{% endblock %}